<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2024-06-29 Sat 09:09 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>&lrm;</title>
<meta name="author" content="John Kitchin" />
<meta name="generator" content="Org Mode" />
<style type="text/css">
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
</head>
<body>
<div id="content" class="content">
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orge38b746">1. SDL-light demo</a>
<ul>
<li><a href="#org848c60f">1.1. The "instrument"</a></li>
<li><a href="#orgc03c9b5">1.2. Iterating over RGB tuples</a></li>
<li><a href="#org3751b55">1.3. Python library</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-orge38b746" class="outline-2">
<h2 id="orge38b746"><span class="section-number-2">1.</span> SDL-light demo</h2>
<div class="outline-text-2" id="text-1">

<div id="org80eb53b" class="figure">
<p><img src="./screenshots/date-09-06-2024-time-19-29-06.png" alt="date-09-06-2024-time-19-29-06.png" />
</p>
</div>



<p>
There is a Google Colab outlining a free self-driving lab demo <a href="cite:&amp;baird-2022-what-is">cite:&amp;baird-2022-what-is</a> at <a href="https://colab.research.google.com/github/sparks-baird/self-driving-lab-demo/blob/main/notebooks/4.2-paho-mqtt-colab-sdl-demo-test.ipynb">https://colab.research.google.com/github/sparks-baird/self-driving-lab-demo/blob/main/notebooks/4.2-paho-mqtt-colab-sdl-demo-test.ipynb</a>. I like the idea, but I found the notebook hard to follow, especially for a total beginner. I developed a simpler library (<a href="#org3751b55">1.3</a>) below to explore using org-mode for an electronic laboratory notebook.
</p>


<p>
This first post simply introduces the "instrument", and some basic use of org-mode so we have something to talk about.
</p>
</div>
<div id="outline-container-org848c60f" class="outline-3">
<h3 id="org848c60f"><span class="section-number-3">1.1.</span> The "instrument"</h3>
<div class="outline-text-3" id="text-1-1">
<p>
You can see details about the instrument in the Colab link above. The gist is we can send three integers to light up R, G, and B LEDs at different intensities. The instrument has spectrometer that measures the intensities at 8 frequencies. Here are the 8 channels and frequencies (in nm) that are measured.
</p>

<div class="org-src-container">
<pre class="src src-jupyter-python"><span style="color: #0000FF;">from</span> mysdl <span style="color: #0000FF;">import</span> *

CHANNEL_NAMES
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">ch410</td>
<td class="org-left">ch440</td>
<td class="org-left">ch470</td>
<td class="org-left">ch510</td>
<td class="org-left">ch550</td>
<td class="org-left">ch583</td>
<td class="org-left">ch620</td>
<td class="org-left">ch670</td>
</tr>
</tbody>
</table>

<p>
To make a "measurement" we simply call our function, and it sends the integers, and eventually returns an array of 8 float numbers for the intensities in each channel. It takes 5-12 seconds to run this experiment. 
</p>

<div class="org-src-container">
<pre class="src src-jupyter-python">measure(0, 100, 0)
</pre>
</div>

<pre class="example" id="org88bb9c9">
---------------------------------------------------------------------------
Empty                                     Traceback (most recent call last)
File ~/anaconda3/lib/python3.11/site-packages/self_driving_lab_demo/utils/observe.py:106, in mqtt_observe_sensor_data(R, G, B, atime, astep, gain, pico_id, session_id, timeout, queue_timeout, client, username, password, hostname, port, tls, mongodb, extra_info)
    105 try:
--&gt; 106     sensor_data = sensor_data_queue.get(True, queue_timeout)
    107 except Empty as e:

File ~/anaconda3/lib/python3.11/queue.py:179, in Queue.get(self, block, timeout)
    178 if remaining &lt;= 0.0:
--&gt; 179     raise Empty
    180 self.not_empty.wait(remaining)

Empty: 

The above exception was the direct cause of the following exception:

Empty                                     Traceback (most recent call last)
Cell In[5], line 1
----&gt; 1 measure(0, 100, 0)

File ~/Dropbox/emacs/projects/scimax-eln/sdl-light/mysdl.py:30, in measure(R, G, B)
     10 def measure(R, G, B):
     11     """Get a measurement from the SDL-light instrument
     12 
     13     Parameters
   (...)
     28     410, 440, 470, 510, 550, 583, 620, and 670 nm.
     29     """
---&gt; 30     result = mqtt_observe_sensor_data(R, G, B,
     31                                       pico_id=PICO_ID,
     32                                       client=client)
     33     background = np.array([result['background'][ch] for ch in CHANNEL_NAMES])
     34     measured = np.array([result[ch] for ch in CHANNEL_NAMES])

File ~/anaconda3/lib/python3.11/site-packages/self_driving_lab_demo/utils/observe.py:108, in mqtt_observe_sensor_data(R, G, B, atime, astep, gain, pico_id, session_id, timeout, queue_timeout, client, username, password, hostname, port, tls, mongodb, extra_info)
    106     sensor_data = sensor_data_queue.get(True, queue_timeout)
    107 except Empty as e:
--&gt; 108     raise Empty(
    109         f"Sensor data retrieval timed out ({queue_timeout} seconds)"
    110     ) from e
    111 inp = sensor_data["_input_message"]
    113 if (
    114     isinstance(inp, dict)
    115     and inp["_session_id"] == session_id
    116     and inp["_experiment_id"] == experiment_id
    117 ):

Empty: Sensor data retrieval timed out (60 seconds)
</pre>

<p>
The output is saved as text (and in memory, but that is ephemeral). We can use some python magic to get the result here so we don't have to run it again (imagine if it takes a long time, or we only have enough reagent or time to do that one run).
</p>

<div class="org-src-container">
<pre class="src src-jupyter-python"><span style="color: #BA36A5;">result</span> = _
result
</pre>
</div>

<p>
array([ 1.52915955,  0.74707031, 38.82820129, 80.03768921,  8.82476807,
        1.89102173,  2.00775146,  2.0816803 ])
</p>

<p>
In this form, the data is not FAIR. It is not really findable, interoperable or reusable; we cannot easily use it in other tools. It is not even that easy to tell what the inputs were; they are separated. There are a lot of ways we might solve this, and a number of challenges to deal with. I am going to take a simple approach that uses json (specifically jsonlines) to save results as one line per experiment in a single file. The biggest challenge here I think is serializing the numpy array; these do not convert to json automatically without some effort. I use orjson for this.
</p>

<div class="org-src-container">
<pre class="src src-jupyter-python"><span style="color: #0000FF;">import</span> orjson
<span style="color: #0000FF;">import</span> jsonlines
<span style="color: #0000FF;">from</span> functools <span style="color: #0000FF;">import</span> partial

<span style="color: #0000FF;">with</span> jsonlines.<span style="color: #006FE0;">open</span>(<span style="color: #008000;">'results.jsonl'</span>, mode=<span style="color: #008000;">'a'</span>, dumps=partial(orjson.dumps, option=orjson.OPT_SERIALIZE_NUMPY)) <span style="color: #0000FF;">as</span> writer:
    writer.write({<span style="color: #008000;">'RGB'</span>: (0, 100, 0), <span style="color: #008000;">'result'</span>: result})
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">cat results.jsonl
</pre>
</div>


<div class="org-src-container">
<pre class="src src-sh">cat results.jsonl | jq -c <span style="color: #008000;">'.RGB'</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgc03c9b5" class="outline-3">
<h3 id="orgc03c9b5"><span class="section-number-3">1.2.</span> Iterating over RGB tuples</h3>
<div class="outline-text-3" id="text-1-2">
<p>
We won't want to run each experiment manually. Instead, we might plan an experimental campaign, like the one in <a href="ref:RGB-values">ref:RGB-values</a> where each row is an experiment to run. We run a few replicates here.
</p>

<table id="org3079d8c" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">R</th>
<th scope="col" class="org-right">G</th>
<th scope="col" class="org-right">B</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">100</td>
<td class="org-right">0</td>
<td class="org-right">0</td>
</tr>

<tr>
<td class="org-right">100</td>
<td class="org-right">0</td>
<td class="org-right">0</td>
</tr>

<tr>
<td class="org-right">100</td>
<td class="org-right">0</td>
<td class="org-right">0</td>
</tr>

<tr>
<td class="org-right">0</td>
<td class="org-right">100</td>
<td class="org-right">0</td>
</tr>

<tr>
<td class="org-right">0</td>
<td class="org-right">100</td>
<td class="org-right">0</td>
</tr>

<tr>
<td class="org-right">0</td>
<td class="org-right">100</td>
<td class="org-right">0</td>
</tr>

<tr>
<td class="org-right">0</td>
<td class="org-right">0</td>
<td class="org-right">100</td>
</tr>

<tr>
<td class="org-right">0</td>
<td class="org-right">0</td>
<td class="org-right">100</td>
</tr>

<tr>
<td class="org-right">0</td>
<td class="org-right">0</td>
<td class="org-right">100</td>
</tr>
</tbody>
</table>

<p>
Here we run and save each result.
</p>

<div class="org-src-container">
<pre class="src src-jupyter-python"><span style="color: #0000FF;">with</span> jsonlines.<span style="color: #006FE0;">open</span>(<span style="color: #008000;">'results.jsonl'</span>, mode=<span style="color: #008000;">'a'</span>,
                    dumps=partial(orjson.dumps,
                                  option=orjson.OPT_SERIALIZE_NUMPY)) <span style="color: #0000FF;">as</span> writer:
    <span style="color: #0000FF;">for</span> R, G, B <span style="color: #0000FF;">in</span> RGB:        
        writer.write({<span style="color: #008000;">'RGB'</span>: (R, G, B), <span style="color: #008000;">'result'</span>: measure(R, G, B)})    
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">cat results.jsonl | jq -c <span style="color: #008000;">'.RGB'</span>
</pre>
</div>

<p>
And to further show interoperability and reusability, we analyze the reproducibility of the second channel from the data.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #0000FF;">import</span> jsonlines

<span style="color: #0000FF;">with</span> jsonlines.<span style="color: #006FE0;">open</span>(<span style="color: #008000;">'results.jsonl'</span>) <span style="color: #0000FF;">as</span> reader:
    <span style="color: #BA36A5;">G</span> = [line[<span style="color: #008000;">'result'</span>][1] <span style="color: #0000FF;">for</span> line <span style="color: #0000FF;">in</span> reader <span style="color: #0000FF;">if</span> line[<span style="color: #008000;">'RGB'</span>] == [0, 0, 100]]

<span style="color: #006FE0;">print</span>(G)    
</pre>
</div>
</div>
</div>
<div id="outline-container-org3751b55" class="outline-3">
<h3 id="org3751b55"><span class="section-number-3">1.3.</span> Python library</h3>
<div class="outline-text-3" id="text-1-3">
<p>
The goal here is simply to have a single function.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #0000FF;">from</span> self_driving_lab_demo <span style="color: #0000FF;">import</span> (get_paho_client, mqtt_observe_sensor_data)
<span style="color: #0000FF;">from</span> self_driving_lab_demo.utils.channel_info <span style="color: #0000FF;">import</span> CHANNEL_NAMES, CHANNEL_WAVELENGTHS_MEAN_FWHM, CHANNEL_HEX_COLORS


<span style="color: #BA36A5;">PICO_ID</span> = <span style="color: #008000;">'test'</span>
<span style="color: #BA36A5;">client</span> = get_paho_client(f<span style="color: #008000;">"sdl-demo/picow/</span>{PICO_ID}<span style="color: #008000;">/as7341/"</span>)

<span style="color: #0000FF;">import</span> numpy <span style="color: #0000FF;">as</span> np

<span style="color: #0000FF;">def</span> <span style="color: #006699;">measure</span>(R, G, B):
    <span style="color: #036A07;">"""Get a measurement from the SDL-light instrument</span>

<span style="color: #036A07;">    Parameters</span>
<span style="color: #036A07;">    ----------</span>

<span style="color: #036A07;">    R : int</span>
<span style="color: #036A07;">    Integer level for the red LED (0-255)</span>

<span style="color: #036A07;">    G : int</span>
<span style="color: #036A07;">    Integer level for the green LED (0-255)</span>

<span style="color: #036A07;">    B : int</span>
<span style="color: #036A07;">    Integer level for the blue LED (0-255)</span>

<span style="color: #036A07;">    Returns</span>
<span style="color: #036A07;">    -------</span>
<span style="color: #036A07;">    an array of float intensities for these wavelengths</span>
<span style="color: #036A07;">    410, 440, 470, 510, 550, 583, 620, and 670 nm.</span>
<span style="color: #036A07;">    """</span>
    <span style="color: #BA36A5;">result</span> = mqtt_observe_sensor_data(R, G, B,
                                      pico_id=PICO_ID,
                                      client=client)
    <span style="color: #BA36A5;">background</span> = np.array([result[<span style="color: #008000;">'background'</span>][ch] <span style="color: #0000FF;">for</span> ch <span style="color: #0000FF;">in</span> CHANNEL_NAMES])
    <span style="color: #BA36A5;">measured</span> = np.array([result[ch] <span style="color: #0000FF;">for</span> ch <span style="color: #0000FF;">in</span> CHANNEL_NAMES])
    <span style="color: #BA36A5;">result</span>[<span style="color: #008000;">'measured'</span>] = (measured - background) / 2**16 * 255
    <span style="color: #0000FF;">return</span> result
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: John Kitchin</p>
<p class="date">Created: 2024-06-29 Sat 09:09</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
