<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2024-07-10 Wed 15:15 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>A Latin Hypercube experimental design to estimate effects in the SDL-Light</title>
<meta name="generator" content="Org Mode" />
<style type="text/css">
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
</head>
<body>
<div id="content" class="content">
<h1 class="title">A Latin Hypercube experimental design to estimate effects in the SDL-Light</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orgcc087a5">1. An example</a></li>
<li><a href="#orgbdd0abb">2. SDL-Light example</a></li>
</ul>
</div>
</div>

<div id="org3e868af" class="figure">
<p><img src="./screenshots/date-09-07-2024-time-10-05-58.png" alt="date-09-07-2024-time-10-05-58.png" />
</p>
</div>
<div id="outline-container-orgcc087a5" class="outline-2">
<h2 id="orgcc087a5"><span class="section-number-2">1.</span> An example</h2>
<div class="outline-text-2" id="text-1">
<p>
We are testing the effects of an additive on car performance. We have 4 additives to test. We are worried however, that the effect may vary by the car (e.g. different kinds of cars) and driver (e.g. from different driving habits). A Latin Square design of experiments allows us to estimate the significance of these factors with a minimum of experiments. At 4 cars, 4 drivers, and 4 additives, we would have to do 64 experiments to try all the combinations.
</p>

<p>
In a Latin square design we will only do 16 experiments. These experiments are "blocked" so we can separate the effects from each factor. Then we consider this simple model:
</p>

<p>
result = average + effect<sub>1</sub> + effect<sub>2</sub> + effect<sub>3</sub> + residuals
</p>

<p>
We can compute the variance for each of these and compare that to the variance of the residuals. If the variance of an effect is much larger than that of the residuals, it is an important factor.
</p>

<p>
Here we introduce <code>pycse.sklearn.lhc</code> for this kind of work.
</p>

<p>
This is a simple setup.
</p>

<div class="org-src-container">
<pre class="src src-jupyter-python">from pycse.sklearn.lhc import LatinSquare

ls = LatinSquare({'car': [1, 2, 3, 4],
                  'driver': ['I', 'II', 'III', 'IV'],
                  'additive': ['A', 'B', 'C', 'D']})
</pre>
</div>

<p>
In the next example we will get the design from the class. This data and design is from 
</p>

<ul class="org-ul">
<li>Box, G., Hunter, J., &amp; Hunter, W. (1978). Statistics for experimenters: an
introduction to design, data analysis, and model building.</li>
</ul>

<p>
It is a named table in org-mode.
</p>

<table id="orgd8c2d1a" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">&#xa0;</th>
<th scope="col" class="org-right">car</th>
<th scope="col" class="org-left">driver</th>
<th scope="col" class="org-left">additive</th>
<th scope="col" class="org-right">result</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">0</td>
<td class="org-right">1</td>
<td class="org-left">I</td>
<td class="org-left">A</td>
<td class="org-right">21</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-left">II</td>
<td class="org-left">D</td>
<td class="org-right">23</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-right">1</td>
<td class="org-left">III</td>
<td class="org-left">B</td>
<td class="org-right">15</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-right">1</td>
<td class="org-left">IV</td>
<td class="org-left">C</td>
<td class="org-right">17</td>
</tr>

<tr>
<td class="org-right">4</td>
<td class="org-right">2</td>
<td class="org-left">I</td>
<td class="org-left">B</td>
<td class="org-right">26</td>
</tr>

<tr>
<td class="org-right">5</td>
<td class="org-right">2</td>
<td class="org-left">II</td>
<td class="org-left">C</td>
<td class="org-right">26</td>
</tr>

<tr>
<td class="org-right">6</td>
<td class="org-right">2</td>
<td class="org-left">III</td>
<td class="org-left">D</td>
<td class="org-right">13</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-right">2</td>
<td class="org-left">IV</td>
<td class="org-left">A</td>
<td class="org-right">15</td>
</tr>

<tr>
<td class="org-right">8</td>
<td class="org-right">3</td>
<td class="org-left">I</td>
<td class="org-left">D</td>
<td class="org-right">20</td>
</tr>

<tr>
<td class="org-right">9</td>
<td class="org-right">3</td>
<td class="org-left">II</td>
<td class="org-left">A</td>
<td class="org-right">20</td>
</tr>

<tr>
<td class="org-right">10</td>
<td class="org-right">3</td>
<td class="org-left">III</td>
<td class="org-left">C</td>
<td class="org-right">16</td>
</tr>

<tr>
<td class="org-right">11</td>
<td class="org-right">3</td>
<td class="org-left">IV</td>
<td class="org-left">B</td>
<td class="org-right">20</td>
</tr>

<tr>
<td class="org-right">12</td>
<td class="org-right">4</td>
<td class="org-left">I</td>
<td class="org-left">C</td>
<td class="org-right">25</td>
</tr>

<tr>
<td class="org-right">13</td>
<td class="org-right">4</td>
<td class="org-left">II</td>
<td class="org-left">B</td>
<td class="org-right">27</td>
</tr>

<tr>
<td class="org-right">14</td>
<td class="org-right">4</td>
<td class="org-left">III</td>
<td class="org-left">A</td>
<td class="org-right">16</td>
</tr>

<tr>
<td class="org-right">15</td>
<td class="org-right">4</td>
<td class="org-left">IV</td>
<td class="org-left">D</td>
<td class="org-right">20</td>
</tr>
</tbody>
</table>

<p>
Here I use the named table to make a Dataframe in Python. The use of <code>:colnames no</code> is unintuitive, but it means to include the column names in the table. org-mode by default does not include those, but we want them as column names.
</p>

<div class="org-src-container">
<pre class="src src-jupyter-python">import pandas as pd

df = pd.DataFrame(data)
df.columns = df.iloc[0]
df = df.drop(columns='')
df = df[1:]
df
</pre>
</div>

<p>
Next we fit the data.
</p>

<div class="org-src-container">
<pre class="src src-jupyter-python">ls.fit(df[['car', 'driver', 'additive']], df['result'])
</pre>
</div>

<p>
And do the analysis of variance.
</p>

<div class="org-src-container">
<pre class="src src-jupyter-python">ls.anova()
</pre>
</div>

<p>
This means the biggest effect on the results is due to the drivers. 
</p>

<div class="org-src-container">
<pre class="src src-jupyter-python">ls.effects['driver']
</pre>
</div>

<p>
It is not that easy to say which additive is best. B appears to have the most positive effect, but more data is needed in more controlled conditions to be sure.
</p>

<div class="org-src-container">
<pre class="src src-jupyter-python">ls.effects['additive']
</pre>
</div>
</div>
</div>
<div id="outline-container-orgbdd0abb" class="outline-2">
<h2 id="orgbdd0abb"><span class="section-number-2">2.</span> SDL-Light example</h2>
<div class="outline-text-2" id="text-2">
<p>
Here we use the SDL-Light instrument and try to determine if the R, G, B variables have an effect on each channel that we measure. We previously explored this in <a href="./averages.html#org00646ae">./averages.html#org00646ae</a>.
</p>

<p>
We set this up as a three factor Latin square, with three levels for each factor.
</p>

<div class="org-src-container">
<pre class="src src-jupyter-python">ls = LatinSquare({'R': [25, 50, 75],
                  'G': [25, 50, 75],
                  'B': [25, 50, 75]})

df = ls.design(shuffle=True)
df
</pre>
</div>

<p>
We can see a more conventional matrix with a pivot table.
</p>

<div class="org-src-container">
<pre class="src src-jupyter-python">ls.pivot()
</pre>
</div>

<p>
Now we setup the experiment code.
</p>

<div class="org-src-container">
<pre class="src src-jupyter-python">import numpy as np
import matplotlib.pyplot as plt
from self_driving_lab_demo import (get_paho_client, mqtt_observe_sensor_data)

PICO_ID = 'test'
client = get_paho_client(f"sdl-demo/picow/{PICO_ID}/as7341/")

def get_results(R, G, B, label=None):
    return mqtt_observe_sensor_data(R, G, B, pico_id=PICO_ID, client=client)

from tqdm import tqdm
from pycse.hashcache import HashCache

@HashCache
def measure(RGB, label=None):
    results = []
    for rgb in tqdm(RGB):
        result = get_results(*rgb, label)
        results += [[result['ch620'], result['ch510'], result['ch470']]]
    return np.array(results)
</pre>
</div>

<p>
And run the experiments. We store the outputs in the dataframe.
</p>

<div class="org-src-container">
<pre class="src src-jupyter-python">results = measure(df[['R', 'G', 'B']].values)
df = df.assign(Rout=results[:, 0],
               Gout=results[:, 1],
               Bout=results[:, 2])
df
</pre>
</div>

<p>
We can fit the model to one of the outputs.
</p>

<div class="org-src-container">
<pre class="src src-jupyter-python">ls.fit(df[['R', 'G', 'B']], df['Bout'])
</pre>
</div>

<div class="org-src-container">
<pre class="src src-jupyter-python">print(ls.anova())
</pre>
</div>



<div class="org-src-container">
<pre class="src src-jupyter-python">ls.effects['R']
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Created: 2024-07-10 Wed 15:15</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
