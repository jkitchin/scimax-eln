<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2024-07-04 Thu 19:16 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Reproducibility, significant differences and interactions in the SDL-Light</title>
<meta name="generator" content="Org Mode" />
<style type="text/css">
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
</head>
<body>
<div id="content" class="content">
<h1 class="title">Reproducibility, significant differences and interactions in the SDL-Light</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org8b44166">1. Reproducibility</a>
<ul>
<li><a href="#org68f978a">1.1. A baseline</a></li>
<li><a href="#org9334d30">1.2. Perturbations on R, G and B</a>
<ul>
<li><a href="#org266f0f6">1.2.1. R channel analysis</a></li>
<li><a href="#org0afb8ab">1.2.2. G channel analysis</a></li>
<li><a href="#org8c126dc">1.2.3. B channel analysis</a></li>
</ul>
</li>
<li><a href="#orge251f8f">1.3. How linear is it?</a></li>
<li><a href="#orgb720c79">1.4. What states are actually accessible</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="org-src-container">
<pre class="src src-jupyter-python">import numpy as np
import matplotlib.pyplot as plt
from self_driving_lab_demo import (get_paho_client, mqtt_observe_sensor_data)

PICO_ID = 'test'
client = get_paho_client(f"sdl-demo/picow/{PICO_ID}/as7341/")

from pycse.hashcache import HashCache

@HashCache
def get_results(R, G, B, label=None):
    return mqtt_observe_sensor_data(R, G, B, pico_id=PICO_ID, client=client)

def measure(R, G, B, label=None):
    results = get_results(R, G, B, label)
    return results['ch620'], results['ch510'], results['ch470']
</pre>
</div>
<div id="outline-container-org8b44166" class="outline-2">
<h2 id="org8b44166"><span class="section-number-2">1.</span> Reproducibility</h2>
<div class="outline-text-2" id="text-1">
<p>
We have to evaluate how reproducible a measurement is, and whether it is impacted by how we measure it. 
</p>
</div>
<div id="outline-container-org68f978a" class="outline-3">
<h3 id="org68f978a"><span class="section-number-3">1.1.</span> A baseline</h3>
<div class="outline-text-3" id="text-1-1">
<p>
We establish a base line here by making the same measurement 50 times. We have to assume that what we measure here will be similar at other values.
</p>

<div class="org-src-container">
<pre class="src src-jupyter-python">from tqdm import tqdm
base = []
for i in tqdm(range(50)):
    base += [measure(50, 50, 50, f'jul-4-base-{i}')]
</pre>
</div>

<div class="org-src-container">
<pre class="src src-jupyter-python">import numpy as np

np.mean(base, axis=0), np.std(base, axis=0)
</pre>
</div>

<p>
We should check if there are any temporal trends, e.g. a systematic change in the order we ran these. This could happen for a variety of reasons, e.g. something heats up and changes over time, something degrades over time, etc.
</p>

<div class="org-src-container">
<pre class="src src-jupyter-python">plt.plot(base - np.mean(base, axis=0))
plt.xlabel('sequence')
plt.ylabel('RGB');
</pre>
</div>

<p>
It actually does appear there is a shift over time here, but it is not large.
</p>

<div class="org-src-container">
<pre class="src src-jupyter-python">fig, axs = plt.subplots(1, 3)
C = 'rgb'
for i, c in enumerate(C):
    axs[i].hist(base[:, i], color=C[i])
</pre>
</div>
</div>
</div>
<div id="outline-container-org9334d30" class="outline-3">
<h3 id="org9334d30"><span class="section-number-3">1.2.</span> Perturbations on R, G and B</h3>
<div class="outline-text-3" id="text-1-2">
<div class="org-src-container">
<pre class="src src-jupyter-python">R = []
for i in tqdm(range(50)):
    R += [measure(51, 50, 50, f'jul-4-R-{i}')]

G = []
for i in tqdm(range(50)):
    G += [measure(50, 51, 50, f'jul-4-G-{i}')]

B = []
for i in tqdm(range(50)):
    B += [measure(50, 50, 51, f'jul-4-B-{i}')]        

base = np.array(base)
R = np.array(R)
G = np.array(G)
B = np.array(B)
</pre>
</div>


<div class="org-src-container">
<pre class="src src-jupyter-python">plt.plot(R - np.mean(R, axis=0), c='r');
plt.plot(G - np.mean(G, axis=0), c='b');
plt.plot(B - np.mean(B, axis=0), c='g');
</pre>
</div>

<p>
It is not obvious there is any drift here.
</p>
</div>
<div id="outline-container-org266f0f6" class="outline-4">
<h4 id="org266f0f6"><span class="section-number-4">1.2.1.</span> R channel analysis</h4>
<div class="outline-text-4" id="text-1-2-1">
<div class="org-src-container">
<pre class="src src-jupyter-python">import matplotlib.pyplot as plt
fig, (ax1, ax2, ax3) = plt.subplots(1, 3)

ax1.hist(base[:, 0], color='k', alpha=0.5);
ax1.hist(R[:, 0], color='r', alpha=0.5);

ax2.hist(base[:, 1], color='k', alpha=0.5);
ax2.hist(R[:, 1], color='g', alpha=0.5);

ax3.hist(base[:, 2], color='k', alpha=0.5);
ax3.hist(R[:, 2], color='b', alpha=0.5);
</pre>
</div>


<div class="org-src-container">
<pre class="src src-jupyter-python">np.mean(R, axis=0) - np.mean(base, axis=0)
</pre>
</div>

<p>
Z-scores
</p>

<div class="org-src-container">
<pre class="src src-jupyter-python">np.abs(np.mean(R, axis=0) - np.mean(base, axis=0)) / np.std(base, axis=0)
</pre>
</div>

<p>
For these measurements the difference in the red channel is unambigously real, and we cannot say the difference in the other channels is meaningful.
</p>
</div>
</div>
<div id="outline-container-org0afb8ab" class="outline-4">
<h4 id="org0afb8ab"><span class="section-number-4">1.2.2.</span> G channel analysis</h4>
<div class="outline-text-4" id="text-1-2-2">
<div class="org-src-container">
<pre class="src src-jupyter-python">fig, (ax1, ax2, ax3) = plt.subplots(1, 3)

ax1.hist(base[:, 0], color='k', alpha=0.5);
ax1.hist(G[:, 0], color='r', alpha=0.5);

ax2.hist(base[:, 1], color='k', alpha=0.5);
ax2.hist(G[:, 1], color='g', alpha=0.5);

ax3.hist(base[:, 2], color='k', alpha=0.5);
ax3.hist(G[:, 2], color='b', alpha=0.5);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-jupyter-python">(np.mean(G, axis=0) - np.mean(base, axis=0)).round(1)
</pre>
</div>

<p>
Z scores
</p>
<div class="org-src-container">
<pre class="src src-jupyter-python">(np.abs(np.mean(G, axis=0) - np.mean(base, axis=0)) / np.std(base, axis=0)).round(1)
</pre>
</div>

<p>
Here there is a meaningful difference in G and B, and no difference in R.
</p>
</div>
</div>
<div id="outline-container-org8c126dc" class="outline-4">
<h4 id="org8c126dc"><span class="section-number-4">1.2.3.</span> B channel analysis</h4>
<div class="outline-text-4" id="text-1-2-3">
<div class="org-src-container">
<pre class="src src-jupyter-python">fig, (ax1, ax2, ax3) = plt.subplots(1, 3)

ax1.hist(base[:, 0], color='k', alpha=0.5);
ax1.hist(B[:, 0], color='r', alpha=0.5);

ax2.hist(base[:, 1], color='k', alpha=0.5);
ax2.hist(B[:, 1], color='g', alpha=0.5);

ax3.hist(base[:, 2], color='k', alpha=0.5);
ax3.hist(B[:, 2], color='b', alpha=0.5);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-jupyter-python">(np.mean(B, axis=0) - np.mean(base, axis=0)).round(1)
</pre>
</div>

<p>
Z-scores
</p>

<div class="org-src-container">
<pre class="src src-jupyter-python">np.abs(np.mean(B, axis=0) - np.mean(base, axis=0)) / np.std(base, axis=0)
</pre>
</div>

<p>
Curiously,  there is a significant difference in R here, but not in B.
</p>
</div>
</div>
</div>
<div id="outline-container-orge251f8f" class="outline-3">
<h3 id="orge251f8f"><span class="section-number-3">1.3.</span> How linear is it?</h3>
<div class="outline-text-3" id="text-1-3">
<p>
Here we check the output of the measurements over a range of settings for each color channel. We expect that the main effect should be on the channel closest in color, and the other channels should be flat. If they are not flat, it means there is some interaction or cross-talk between the channels.
</p>

<div class="org-src-container">
<pre class="src src-jupyter-python">setting = np.arange(0, 100, 5)

R, G, B = [], [], []
for i in setting:
    R += [measure(i, 0, 0)]
    G += [measure(0, i, 0)]
    B += [measure(0, 0, i)]

R = np.array(R)
G = np.array(G)
B = np.array(B)

fig, axs = plt.subplots(1, 3)
p = axs[0].plot(setting, R, '.-')
axs[0].set_title('Vary R')
for c, line in enumerate(p):
    line.set_color('rgb'[c])

p = axs[1].plot(setting, G, '.-')
axs[1].set_title('Vary G')
for c, line in enumerate(p):
    line.set_color('rgb'[c])

p = axs[2].plot(setting, B, '.-')
axs[2].set_title('Vary B')
for c, line in enumerate(p):
    line.set_color('rgb'[c])

plt.tight_layout();
</pre>
</div>


<p>
By inspection we can see that there is certainly cross-talk, or some interaction between the channels. That probably means the R, G, B LED is not "pure", but outputs a range of wavelengths that these channels are detecting. The G channel of the LED for example, obviously outputs a blue light component, and the B channel of the LED appears to have a small amount of red and green light in it.
</p>

<p>
It is also evident the output is nonlinear at low settings.
</p>
</div>
</div>
<div id="outline-container-orgb720c79" class="outline-3">
<h3 id="orgb720c79"><span class="section-number-3">1.4.</span> What states are actually accessible</h3>
<div class="outline-text-3" id="text-1-4">
<p>
We are going to randomly sample three states on each channel. It is important to set a random seed here for reproducibility. To retrieve these results from the cache, you have to use the same seed, otherwise you will get new random numbers which will trigger new experiments.
</p>

<div class="org-src-container">
<pre class="src src-jupyter-python">np.random.seed(42)
states = []
for i in tqdm(range(150)):
    states += [measure(np.random.choice([43, 44, 45]),
                       np.random.choice([58, 59, 60]),
                       np.random.choice([34, 35, 36]),
                       f'state-{i}')]

states = np.array(states)    

plt.scatter(*states[:, 0:2].T, c=states[:, 2], alpha=0.2)
plt.xlabel('R output')
plt.ylabel('G output')
plt.colorbar();
</pre>
</div>

<p>
This makes it more clear we cannot access all output state space because the input space is discretized. There are some unusual outliers too.
</p>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Date: 2024-07-04 Thu 00:00</p>
<p class="date">Created: 2024-07-04 Thu 19:16</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
