<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2024-07-07 Sun 18:42 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SDL-Light with a design of experiment approach</title>
<meta name="generator" content="Org Mode" />
<style type="text/css">
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<script>
  window.MathJax = {
    tex: {
      ams: {
        multlineWidth: '85%'
      },
      tags: 'ams',
      tagSide: 'right',
      tagIndent: '.8em'
    },
    chtml: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    svg: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    output: {
      font: 'mathjax-modern',
      displayOverflow: 'overflow'
    }
  };
</script>

<script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
</head>
<body>
<div id="content" class="content">
<h1 class="title">SDL-Light with a design of experiment approach</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org7730629">1. A design of experiment</a></li>
<li><a href="#org665f32c">2. Run the experiments</a></li>
<li><a href="#orgbef2af4">3. A simple linear model</a></li>
</ul>
</div>
</div>

<div id="org14ebcc0" class="figure">
<p><img src="./screenshots/date-03-07-2024-time-14-19-43.png" alt="date-03-07-2024-time-14-19-43.png" />
</p>
</div>



<p>
There are three "knobs" you can vary in the SDL-Light demo: the R, G and B intensities. There are 8 sensors at different wavelengths that detect the light that is emitted. Here we explore how to find a set of RGB values that will result in a specific reading on the sensors. Specifically we want an RGB setting that results in a reading of 10,000 on the ch620, ch510, and ch470 channels, which are approximately red, green and blue wavelengths.
</p>

<p>
We previously saw that at least the blue channel is slightly nonlinear in the B setting, and we can assume that is true here too. Rather than randomly sample the RGB space, we will use a design of experiment (DOE) approach.
</p>
<div id="outline-container-org7730629" class="outline-2">
<h2 id="org7730629"><span class="section-number-2">1.</span> A design of experiment</h2>
<div class="outline-text-2" id="text-1">
<p>
We will use <a href="https://pydoe3.readthedocs.io/en/latest/">https://pydoe3.readthedocs.io/en/latest/</a> to set up our DOE.
</p>

<p>
We need an experimental design, which is a set of experiments to run. We have three variables here, and we test them at three levels, low, middle and high. The design comes out in "coded" levels. The design creates 15 experiments, with some replicates at the center point.
</p>

<div class="org-src-container">
<pre class="src src-jupyter-python">from pyDOE3 import bbdesign
import numpy as np
import pandas as pd

design = bbdesign(n=3)
D = pd.DataFrame(design, columns=['Rc', 'Gc', 'Bc'])
D
</pre>
</div>

<p>
We have to convert the coded levels to actual values. We use a little knowledge from before where we expect an answer around 50, so we make that the center of the range.
</p>

<div class="org-src-container">
<pre class="src src-jupyter-python">a, b = -1, 1
Rmin, Rmax = 25, 75
Gmin, Gmax = 25, 75
Bmin, Bmax = 25, 75

D['Rint'] = ((D['Rc'] - a) * (Rmax - Rmin) / (b - a) + Rmin).astype(int)
D['Gint'] = ((D['Gc'] - a) * (Rmax - Rmin) / (b - a) + Gmin).astype(int)
D['Bint'] = ((D['Bc'] - a) * (Rmax - Rmin) / (b - a) + Bmin).astype(int)

D
</pre>
</div>

<p>
We setup some functions to help drive our experiments. I use HashCache again, with an optional label so we can run these again if we want to.
</p>

<div class="org-src-container">
<pre class="src src-jupyter-python">from self_driving_lab_demo import (get_paho_client, mqtt_observe_sensor_data)

PICO_ID = 'test'
client = get_paho_client(f"sdl-demo/picow/{PICO_ID}/as7341/")

from pycse.hashcache import HashCache

@HashCache
def get_results(R, G, B, label=None):
    return mqtt_observe_sensor_data(R, G, B, pico_id=PICO_ID, client=client)

def measure(R, G, B, label=None):
    results = get_results(R, G, B, label)
    return results['ch620'], results['ch510'], results['ch470']
</pre>
</div>

<p>
Test that it works.
</p>

<div class="org-src-container">
<pre class="src src-jupyter-python">print(measure(44, 59, 36))
</pre>
</div>
</div>
</div>
<div id="outline-container-org665f32c" class="outline-2">
<h2 id="org665f32c"><span class="section-number-2">2.</span> Run the experiments</h2>
<div class="outline-text-2" id="text-2">
<p>
We should run the experiments in a randomized order. This is important to remove run-order artifacts. For example, suppose the output of the LED is sensitive to temperature, and the LED heats up during the experiment. That would result in a systematic increase in temperature over the runs. By randomizing the run order, this still happens, but the effect is not systematic in the order of the experiments, it is randomized.
</p>

<div class="org-src-container">
<pre class="src src-jupyter-python">input = D[['Rint', 'Gint', 'Bint']].sample(frac=1)
input
</pre>
</div>

<div class="org-src-container">
<pre class="src src-jupyter-python">from tqdm import tqdm
index = []
output = []
for i, RGB in tqdm(input.iterrows()):
    result = measure(*RGB, f'jul-3-{i}')    
    index += [i]
    output += [result]

output = pd.DataFrame(output, index=index)
output
</pre>
</div>

<p>
We should explore the data a little. First we look at the replicates. Since we shuffled the data, we need to select them.
</p>

<div class="org-src-container">
<pre class="src src-jupyter-python">input.query('Rint==50 &amp; Bint==50 &amp; Gint==50').index
</pre>
</div>

<div class="org-src-container">
<pre class="src src-jupyter-python">output.loc[input.query('Rint==50 &amp; Bint==50 &amp; Gint==50').index]
</pre>
</div>
</div>
</div>
<div id="outline-container-orgbef2af4" class="outline-2">
<h2 id="orgbef2af4"><span class="section-number-2">3.</span> A simple linear model</h2>
<div class="outline-text-2" id="text-3">
<p>
Now we need to build a model. A simple model is \(out = in @ pars\), in other words, a simple linear model.
</p>

<div class="org-src-container">
<pre class="src src-jupyter-python">pars, resid, rank, s = np.linalg.lstsq(input, output, rcond=None)

with np.printoptions(precision=1):
    print(pars)
</pre>
</div>

<p>
The structure of that array supports the largely linear model; the diagonal is large, and the off-diagonals are small. 
</p>

<div class="org-src-container">
<pre class="src src-jupyter-python">import matplotlib.pyplot as plt

p = plt.plot(output, input@pars, '.')

p[0].set_color('r')
p[1].set_color('g')
p[2].set_color('b')

plt.legend(['R', 'G', 'B']);
</pre>
</div>

<p>
Solve for input that yields (10K, 10K, 10K)
</p>

<div class="org-src-container">
<pre class="src src-jupyter-python">s = np.round([10000, 10000, 10000] @ np.linalg.inv(pars), 0)
s
</pre>
</div>


<div class="org-src-container">
<pre class="src src-jupyter-python">print(measure(*s))
</pre>
</div>

<p>
That seems close. We can try a more sophisticated model like a quadratic polynomial.
</p>

<div class="org-src-container">
<pre class="src src-jupyter-python">from sklearn.preprocessing import PolynomialFeatures
pf = PolynomialFeatures(degree=2, interaction_only=False, include_bias=False)
Xp = pf.fit_transform(input)
print(Xp.shape)
pars, resid, rank, s = np.linalg.lstsq(Xp, output, rcond=None)
pars
</pre>
</div>

<p>
Not surprisingly, the fit is better.
</p>

<div class="org-src-container">
<pre class="src src-jupyter-python">p = plt.plot(output, Xp@pars, '.')

p[0].set_color('r')
p[1].set_color('g')
p[2].set_color('b')

plt.legend(['R', 'G', 'B']);
</pre>
</div>

<p>
It is a little trickier finding the best solution here. I use a minimize function to find the best solution.
</p>

<div class="org-src-container">
<pre class="src src-jupyter-python">def objective(RGB):
    Xp = pf.fit_transform(np.atleast_2d(np.array(RGB)))
    out = (Xp @ pars) - (10000, 10000, 10000)
    return np.sum(out**2)

print(objective([50, 50, 50]))

from scipy.optimize import minimize
sol = minimize(objective, (50, 50, 50))
print(sol.x.astype(int))
</pre>
</div>

<p>
We find a slightly better solution.
</p>

<div class="org-src-container">
<pre class="src src-jupyter-python">print(measure(*sol.x.astype(int)))
</pre>
</div>

<p>
We should test this solution a few times.
</p>

<div class="org-src-container">
<pre class="src src-jupyter-python">m = np.array([measure(*sol.x.astype(int), i) for i in range(10)])
</pre>
</div>

<div class="org-src-container">
<pre class="src src-jupyter-python">_, _, p = plt.hist(m)

c = 'rgb'
for i, group in enumerate(p):
    for patch in group:
        patch.set_color(c[i])
plt.legend(['R', 'G', 'B']);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-jupyter-python">np.mean(m, axis=0)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-jupyter-python">np.std(m, axis=0)
</pre>
</div>

<p>
The target we want is just barely at the outside edge of the upper ~95% confidence range.
</p>

<div class="org-src-container">
<pre class="src src-jupyter-python">np.mean(m, axis=0) + 2 * np.std(m, axis=0)
</pre>
</div>

<p>
The next step might be to refine the design with a second round of experiments that is more focused around the solution.
</p>

<p>
Overall, this is a pretty bare-bones DOE approach. One should do a whole analysis of variance (ANOVA), and incorporate sensitivity analysis and uncertainty quantification. We may also need to do additional refining experiments that should make the average result closer to the goal we set.
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Created: 2024-07-07 Sun 18:42</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
